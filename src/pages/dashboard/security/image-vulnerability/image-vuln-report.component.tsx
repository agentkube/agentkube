import React, { useState, useEffect, useMemo } from 'react';
import { ImageInfo, ScanResult, Vulnerability } from '@/types/vuln';
import { getScanResults } from '@/api/vuln';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import {
  Shield,
  Loader2,
  ArrowUpDown,
  ArrowUp,
  ArrowDown,
  ChevronDown,
  ChevronRight,
  Copy,
  Check,
  ArrowUpRight,
  Package,
  Image as ImageIcon,
  RotateCcw
} from 'lucide-react';
import { openExternalUrl } from '@/api/external';
import { useScan } from '@/contexts/useScan';
import { toast } from '@/hooks/use-toast';

interface ImageVulnReportProps {
  imageInfo: ImageInfo;
}

/**
 * Component to display vulnerability report for a specific image
 */
const ImageVulnReport: React.FC<ImageVulnReportProps> = ({ imageInfo }) => {
  const { reScanImages } = useScan();
  const [scanResult, setScanResult] = useState<ScanResult | null>(null);
  const [loading, setLoading] = useState(false);
  const [scanning, setScanning] = useState(false);
  const [expandedRows, setExpandedRows] = useState<Set<string>>(new Set());
  const [copiedItems, setCopiedItems] = useState<Set<string>>(new Set());
  const [copiedDigest, setCopiedDigest] = useState(false);
  const [searchTerm, setSearchTerm] = useState<string>('');
  const [debouncedSearchTerm, setDebouncedSearchTerm] = useState<string>('');

  // Sorting state
  type SortDirection = 'asc' | 'desc' | null;
  type SortField = 'id' | 'severity' | 'score' | 'package' | 'fix' | null;

  interface SortState {
    field: SortField;
    direction: SortDirection;
  }

  const [sort, setSort] = useState<SortState>({
    field: null,
    direction: null
  });

  // Debounce search term
  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedSearchTerm(searchTerm);
    }, 300);

    return () => clearTimeout(timer);
  }, [searchTerm]);

  // Fetch scan results
  useEffect(() => {
    const fetchScanResults = async () => {
      if (!imageInfo?.image) return;

      setLoading(true);
      try {
        const result = await getScanResults({ image: imageInfo.image });
        setScanResult(result);
      } catch (err) {
        console.error('Error fetching scan results:', err);
      } finally {
        setLoading(false);
      }
    };

    fetchScanResults();
  }, [imageInfo?.image]);

  // Handle re-scan
  const handleReScan = async () => {
    if (!imageInfo?.image) return;

    setScanning(true);
    try {
      await reScanImages([imageInfo.image]);

      // Refresh results after scan
      setTimeout(async () => {
        try {
          const result = await getScanResults({ image: imageInfo.image });
          setScanResult(result);
          toast({
            title: "Scan Complete",
            description: `Successfully rescanned ${imageInfo.image}`
          });
        } catch (err) {
          console.error('Failed to refresh scan results:', err);
        }
      }, 2000);
    } catch (err) {
      console.error('Error re-scanning image:', err);
      toast({
        title: "Scan Failed",
        description: "Failed to rescan image",
        variant: "destructive"
      });
    } finally {
      setScanning(false);
    }
  };

  // Handle reload
  const handleReload = async () => {
    if (!imageInfo?.image) return;

    setLoading(true);
    try {
      const result = await getScanResults({ image: imageInfo.image });
      setScanResult(result);
      toast({
        title: "Results Reloaded",
        description: `Reloaded scan results for ${imageInfo.image}`
      });
    } catch (err) {
      console.error('Error reloading scan results:', err);
      toast({
        title: "Reload Failed",
        description: "Failed to reload scan results",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  // Get severity color
  const getSeverityColor = (severity: string): string => {
    switch (severity.toLowerCase()) {
      case 'critical': return 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300';
      case 'high': return 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300';
      case 'medium': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300';
      case 'low': return 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300';
      default: return 'bg-gray-100 text-gray-800 dark:bg-gray-800/40 dark:text-gray-400';
    }
  };

  // Get CVSS score color
  const getCvssScoreColor = (score: number): string => {
    if (score >= 9.0) return 'text-red-600 dark:text-red-400 font-bold';
    if (score >= 7.0) return 'text-orange-600 dark:text-orange-400 font-medium';
    if (score >= 4.0) return 'text-yellow-600 dark:text-yellow-400 font-medium';
    return 'text-blue-600 dark:text-blue-400';
  };

  // Handle sort
  const handleSort = (field: SortField) => {
    setSort(prevSort => {
      if (prevSort.field === field) {
        if (prevSort.direction === 'asc') {
          return { field, direction: 'desc' };
        } else if (prevSort.direction === 'desc') {
          return { field: null, direction: null };
        } else {
          return { field, direction: 'asc' };
        }
      }
      return { field, direction: 'asc' };
    });
  };

  // Render sort indicator
  const renderSortIndicator = (field: SortField) => {
    if (sort.field !== field) {
      return <ArrowUpDown className="ml-1 h-3 w-3 inline opacity-30" />;
    }

    if (sort.direction === 'asc') {
      return <ArrowUp className="ml-1 h-3 w-3 inline text-blue-500" />;
    }

    if (sort.direction === 'desc') {
      return <ArrowDown className="ml-1 h-3 w-3 inline text-blue-500" />;
    }

    return null;
  };

  // Toggle row expansion
  const toggleRowExpansion = (vulnId: string) => {
    setExpandedRows(prev => {
      const newSet = new Set(prev);
      if (newSet.has(vulnId)) {
        newSet.delete(vulnId);
      } else {
        newSet.add(vulnId);
      }
      return newSet;
    });
  };

  // Handle copy
  const handleCopy = async (text: string, itemKey: string) => {
    try {
      await navigator.clipboard.writeText(text);
      setCopiedItems(prev => new Set([...prev, itemKey]));

      setTimeout(() => {
        setCopiedItems(prev => {
          const newSet = new Set(prev);
          newSet.delete(itemKey);
          return newSet;
        });
      }, 2000);
    } catch (err) {
      console.error('Failed to copy text:', err);
    }
  };

  // Handle copy digest
  const handleCopyDigest = async () => {
    try {
      await navigator.clipboard.writeText(imageInfo.imageId);
      setCopiedDigest(true);
      toast({
        title: "Copied!",
        description: "Image digest copied to clipboard"
      });

      setTimeout(() => {
        setCopiedDigest(false);
      }, 2000);
    } catch (err) {
      console.error('Failed to copy digest:', err);
      toast({
        title: "Copy Failed",
        description: "Failed to copy digest to clipboard",
        variant: "destructive"
      });
    }
  };

  // Filter and sort vulnerabilities
  const filteredVulnerabilities = useMemo(() => {
    if (!scanResult?.vulnerabilities) return [];

    // Filter by search term
    const filtered = debouncedSearchTerm.trim()
      ? scanResult.vulnerabilities.filter(vuln =>
          vuln.id.toLowerCase().includes(debouncedSearchTerm.toLowerCase()) ||
          vuln.packageName.toLowerCase().includes(debouncedSearchTerm.toLowerCase()) ||
          vuln.severity.toLowerCase().includes(debouncedSearchTerm.toLowerCase()) ||
          (vuln.description && vuln.description.toLowerCase().includes(debouncedSearchTerm.toLowerCase()))
        )
      : scanResult.vulnerabilities;

    // Sort vulnerabilities
    if (!sort.field || !sort.direction) {
      return filtered;
    }

    return [...filtered].sort((a, b) => {
      const sortMultiplier = sort.direction === 'asc' ? 1 : -1;

      switch (sort.field) {
        case 'id':
          return a.id.localeCompare(b.id) * sortMultiplier;

        case 'severity': {
          const severityOrder: Record<string, number> = {
            'Critical': 4, 'High': 3, 'Medium': 2, 'Low': 1, 'Unknown': 0
          };
          const orderA = severityOrder[a.severity] || 0;
          const orderB = severityOrder[b.severity] || 0;
          return (orderA - orderB) * sortMultiplier;
        }

        case 'score': {
          const scoreA = a.cvssScore ? parseFloat(a.cvssScore.toString()) : -1;
          const scoreB = b.cvssScore ? parseFloat(b.cvssScore.toString()) : -1;

          if (scoreA === -1 && scoreB === -1) return 0;
          if (scoreA === -1) return 1 * sortMultiplier;
          if (scoreB === -1) return -1 * sortMultiplier;

          return (scoreA - scoreB) * sortMultiplier;
        }

        case 'package':
          return a.packageName.localeCompare(b.packageName) * sortMultiplier;

        case 'fix': {
          const fixA = a.fixVersion || '';
          const fixB = b.fixVersion || '';
          return fixA.localeCompare(fixB) * sortMultiplier;
        }

        default:
          return 0;
      }
    });
  }, [scanResult?.vulnerabilities, sort.field, sort.direction, debouncedSearchTerm]);

  if (loading) {
    return (
      <div className="flex items-center justify-center py-8">
        <Loader2 className="h-6 w-6 animate-spin mr-2" />
        <span className="text-sm text-gray-500">Loading scan results...</span>
      </div>
    );
  }

  return (
    <div className="space-y-4">

      {/* Image Digest and Action Buttons */}
      <div className="flex items-center justify-between gap-2">
        {/* Image Digest with Tooltip */}
        <div className="flex items-center gap-2 text-sm text-gray-700 border px-2 py-1 rounded-md dark:bg-gray-600/10 dark:text-gray-400 flex-1 min-w-0">
          <span className="flex-shrink-0">Digest</span>
          <TooltipProvider>
            <Tooltip>
              <TooltipTrigger asChild>
                <p className="font-mono truncate flex-1 cursor-default hover:cursor-pointer">{imageInfo.imageId}</p>
              </TooltipTrigger>
              <TooltipContent className='p-1 '>
                <p className="font-mono text-xs w-full break-all">{imageInfo.imageId}</p>
              </TooltipContent>
            </Tooltip>
          </TooltipProvider>
          <button
            onClick={handleCopyDigest}
            className="flex-shrink-0 p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors"
          >
            {copiedDigest ? (
              <Check className="h-3 w-3 text-green-500" />
            ) : (
              <Copy className="h-3 w-3 text-gray-500" />
            )}
          </button>
        </div>

        {/* Action Buttons */}
        <div className="flex gap-2 flex-shrink-0">
          <Button
            onClick={handleReload}
            disabled={loading}
            className="h-8 px-2 text-xs"
            variant="outline"
          >
            {loading ? (
              <Loader2 className="h-3 w-3 animate-spin" />
            ) : (
              <RotateCcw className="h-3 w-3" />
            )}
          </Button>
          <Button
            onClick={handleReScan}
            disabled={scanning}
            className="h-8 px-2 text-xs"
          >
            {scanning ? (
              <Loader2 className="h-3 w-3 animate-spin mr-1" />
            ) : (
              <Shield className="h-3 w-3 mr-1" />
            )}
            Re-scan
          </Button>
        </div>
      </div>





      {/* Summary Cards */}
      {scanResult && (
        <div className="grid grid-cols-4 gap-1 mb-6">
          {[
            { label: 'Critical', count: scanResult.summary.critical, severity: 'critical' },
            { label: 'High', count: scanResult.summary.high, severity: 'high' },
            { label: 'Medium', count: scanResult.summary.medium, severity: 'medium' },
            { label: 'Low', count: scanResult.summary.low, severity: 'low' }
          ].map(({ label, count, severity }) => (
            <Card key={label} className="bg-gray-50 dark:bg-transparent rounded-md border border-gray-200 dark:border-gray-800/50 shadow-none min-h-32">
              <CardContent className="py-2 px-2 flex flex-col h-full">
                <h2 className="text-sm uppercase font-medium text-gray-800 dark:text-gray-500 mb-auto">{label}</h2>
                <div className="mt-auto">
                  <p className={`text-5xl font-light mb-1 ${
                    severity === 'critical' ? 'text-red-600 dark:text-red-400' :
                    severity === 'high' ? 'text-orange-600 dark:text-orange-400' :
                    severity === 'medium' ? 'text-yellow-600 dark:text-yellow-400' :
                    'text-blue-600 dark:text-blue-400'
                  }`}>
                    {count}
                  </p>
                  <div className="w-full h-1 bg-gray-200 dark:bg-gray-800/30 rounded-[0.3rem] mt-1">
                    <div className={`h-1 rounded-[0.3rem] ${
                      severity === 'critical' ? 'bg-red-500 dark:bg-red-400' :
                      severity === 'high' ? 'bg-orange-500 dark:bg-orange-400' :
                      severity === 'medium' ? 'bg-yellow-500 dark:bg-yellow-400' :
                      'bg-blue-500 dark:bg-blue-400'
                    }`} style={{ width: '100%' }}></div>
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}

      {/* Search Input */}
      <div className="mb-4">
        <Input
          placeholder="Search vulnerabilities (CVE, package, severity, description)..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          className="w-full"
        />
      </div>

      {/* Vulnerabilities Table */}
      {filteredVulnerabilities.length > 0 && (
        <Card className="bg-transparent border border-gray-200 dark:border-gray-800/50">
          <Table>
            <TableHeader>
              <TableRow className="border-b border-gray-400 dark:border-gray-800/80">
                <TableHead className="w-8"></TableHead>
                <TableHead
                  className="cursor-pointer hover:text-blue-500 w-96"
                  onClick={() => handleSort('id')}
                >
                  CVE {renderSortIndicator('id')}
                </TableHead>
                <TableHead
                  className="cursor-pointer hover:text-blue-500 w-36 text-center"
                  onClick={() => handleSort('score')}
                >
                  Score {renderSortIndicator('score')}
                </TableHead>
                <TableHead
                  className="cursor-pointer hover:text-blue-500"
                  onClick={() => handleSort('fix')}
                >
                  Fix Version {renderSortIndicator('fix')}
                </TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {filteredVulnerabilities.map((vuln, index) => {
                const vulnKey = `${imageInfo.image}-${vuln.id}-${vuln.packageName}-${index}`;
                const isExpanded = expandedRows.has(vulnKey);

                return (
                  <React.Fragment key={vulnKey}>
                    <TableRow
                      className="bg-gray-50 dark:bg-transparent border-b border-gray-400 dark:border-gray-800/80 hover:cursor-pointer hover:bg-gray-300/50 dark:hover:bg-gray-800/30"
                      onClick={() => toggleRowExpansion(vulnKey)}
                    >
                      <TableCell className="w-8">
                        {isExpanded ? (
                          <ChevronDown className="h-4 w-4 text-gray-500" />
                        ) : (
                          <ChevronRight className="h-4 w-4 text-gray-500" />
                        )}
                      </TableCell>
                      <TableCell className="font-medium">
                        <div className="font-mono text-blue-500 dark:text-blue-400 text-sm">{vuln.id}</div>
                        {vuln.description && (
                          <div>
                            <p className="text-xs font-light text-gray-700 dark:text-gray-300">
                              {vuln.description.slice(0, 100)} {vuln.description.length > 100 ? "..." : "."}
                            </p>
                          </div>
                        )}
                      </TableCell>
                      <TableCell className="text-center">
                        {vuln.cvssScore && (
                          <Badge className={getSeverityColor(vuln.severity)}>
                            <span className={getCvssScoreColor(parseFloat(vuln.cvssScore.toString()))}>
                              {vuln.cvssScore}
                            </span>
                          </Badge>
                        )}
                      </TableCell>
                      <TableCell>
                        <span>
                          {vuln.fixVersion || 'Not available'}
                        </span>
                      </TableCell>
                    </TableRow>

                    {/* Expanded Row Details */}
                    {isExpanded && (
                      <TableRow className="bg-gray-100 dark:bg-gray-800/20">
                        <TableCell colSpan={4} className="p-4 dark:hover:bg-transparent">
                          <div className="space-y-4">
                            {/* Description */}
                            {vuln.description && (
                              <div>
                                <h6 className="text-xs font-medium text-gray-600 dark:text-gray-400 mb-2">Description</h6>
                                <p className="text-sm text-gray-700 dark:text-gray-300">{vuln.description}</p>
                              </div>
                            )}

                            <div className="space-y-4">
                              {/* CVSS Score Details */}
                              <div className="border rounded-lg">
                                <div className="bg-gray-200 dark:bg-gray-800/60 p-1 text-gray-600 dark:text-gray-400 flex items-center gap-1">
                                  <Shield className="h-3 w-3" />
                                  <h6 className="text-sm font-medium">Score</h6>
                                </div>
                                <div className="space-y-2 text-sm p-1.5">
                                  {/* Severity */}
                                  <div className="flex items-center justify-between group">
                                    <span className="text-gray-600 dark:text-gray-400 flex-shrink-0">Severity</span>
                                    <div className="flex items-center gap-1 min-w-0">
                                      <Badge className={getSeverityColor(vuln.severity)}>
                                        {vuln.severity}
                                      </Badge>
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          handleCopy(vuln.severity, `${vulnKey}-severity`);
                                        }}
                                        className="opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded flex-shrink-0"
                                      >
                                        {copiedItems.has(`${vulnKey}-severity`) ? (
                                          <Check className="h-3 w-3 text-green-500" />
                                        ) : (
                                          <Copy className="h-3 w-3 text-gray-500" />
                                        )}
                                      </button>
                                    </div>
                                  </div>

                                  {/* CVSS Score */}
                                  {vuln.cvssScore && (
                                    <div className="flex items-center justify-between group">
                                      <span className="text-gray-600 dark:text-gray-400 flex-shrink-0">Score</span>
                                      <div className="flex items-center gap-1 min-w-0">
                                        <Badge className={getSeverityColor(vuln.severity)}>
                                          <span className={getCvssScoreColor(parseFloat(vuln.cvssScore.toString()))}>
                                            {vuln.cvssScore}
                                          </span>
                                        </Badge>
                                        <button
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            handleCopy(vuln.cvssScore?.toString() || '', `${vulnKey}-score`);
                                          }}
                                          className="opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded flex-shrink-0"
                                        >
                                          {copiedItems.has(`${vulnKey}-score`) ? (
                                            <Check className="h-3 w-3 text-green-500" />
                                          ) : (
                                            <Copy className="h-3 w-3 text-gray-500" />
                                          )}
                                        </button>
                                      </div>
                                    </div>
                                  )}

                                  {/* CVSS Vector */}
                                  {vuln.cvssVector && (
                                    <div className="flex items-center justify-between group">
                                      <span className="text-gray-600 dark:text-gray-400 flex-shrink-0">Vector</span>
                                      <div className="flex items-center gap-1 min-w-0">
                                        <span className="truncate font-mono text-xs max-w-56">{vuln.cvssVector}</span>
                                        <button
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            handleCopy(vuln.cvssVector || '', `${vulnKey}-vector`);
                                          }}
                                          className="opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded flex-shrink-0"
                                        >
                                          {copiedItems.has(`${vulnKey}-vector`) ? (
                                            <Check className="h-3 w-3 text-green-500" />
                                          ) : (
                                            <Copy className="h-3 w-3 text-gray-500" />
                                          )}
                                        </button>
                                      </div>
                                    </div>
                                  )}

                                  {/* Modified Date */}
                                  {vuln.lastModifiedDate && (
                                    <div className="flex items-center justify-between group">
                                      <span className="text-gray-600 dark:text-gray-400 flex-shrink-0">Modified</span>
                                      <div className="flex items-center gap-1 min-w-0">
                                        <span className="truncate font-mono text-xs">
                                          {new Date(vuln.lastModifiedDate).toLocaleDateString()}
                                        </span>
                                        <button
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            handleCopy(
                                              vuln.lastModifiedDate ? new Date(vuln.lastModifiedDate).toLocaleDateString() : '',
                                              `${vulnKey}-modified`
                                            );
                                          }}
                                          className="opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded flex-shrink-0"
                                        >
                                          {copiedItems.has(`${vulnKey}-modified`) ? (
                                            <Check className="h-3 w-3 text-green-500" />
                                          ) : (
                                            <Copy className="h-3 w-3 text-gray-500" />
                                          )}
                                        </button>
                                      </div>
                                    </div>
                                  )}
                                </div>
                              </div>

                              {/* Package Details */}
                              <div className="border rounded-lg">
                                <div className="bg-gray-200 dark:bg-gray-800/60 p-1 text-gray-600 dark:text-gray-400 flex items-center gap-1">
                                  <Package className="h-3 w-3" />
                                  <h6 className="text-sm font-medium">Package</h6>
                                </div>
                                <div className="space-y-2 text-sm p-1.5">
                                  {/* Version */}
                                  <div className="flex items-center justify-between group">
                                    <span className="text-gray-600 dark:text-gray-400 flex-shrink-0">Version</span>
                                    <div className="flex items-center gap-1 min-w-0">
                                      <span className="truncate font-mono text-xs">{vuln.version}</span>
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          handleCopy(vuln.version, `${vulnKey}-version`);
                                        }}
                                        className="opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded flex-shrink-0"
                                      >
                                        {copiedItems.has(`${vulnKey}-version`) ? (
                                          <Check className="h-3 w-3 text-green-500" />
                                        ) : (
                                          <Copy className="h-3 w-3 text-gray-500" />
                                        )}
                                      </button>
                                    </div>
                                  </div>

                                  {/* Type */}
                                  <div className="flex items-center justify-between group">
                                    <span className="text-gray-600 dark:text-gray-400 flex-shrink-0">Type</span>
                                    <div className="flex items-center gap-1 min-w-0">
                                      <span className="truncate font-mono text-xs">{vuln.packageType}</span>
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          handleCopy(vuln.packageType, `${vulnKey}-type`);
                                        }}
                                        className="opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded flex-shrink-0"
                                      >
                                        {copiedItems.has(`${vulnKey}-type`) ? (
                                          <Check className="h-3 w-3 text-green-500" />
                                        ) : (
                                          <Copy className="h-3 w-3 text-gray-500" />
                                        )}
                                      </button>
                                    </div>
                                  </div>

                                  {/* Package Name */}
                                  <div className="flex items-center justify-between group">
                                    <div className="flex items-center gap-1 text-gray-600 dark:text-gray-400 flex-shrink-0">
                                      <span>Name</span>
                                    </div>
                                    <div className="flex items-center gap-1 min-w-0">
                                      <span className="truncate font-mono text-xs">{vuln.packageName}</span>
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          handleCopy(vuln.packageName, `${vulnKey}-name`);
                                        }}
                                        className="opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded flex-shrink-0"
                                      >
                                        {copiedItems.has(`${vulnKey}-name`) ? (
                                          <Check className="h-3 w-3 text-green-500" />
                                        ) : (
                                          <Copy className="h-3 w-3 text-gray-500" />
                                        )}
                                      </button>
                                    </div>
                                  </div>

                                  {/* Location */}
                                  {vuln.locations && vuln.locations.length > 0 && (
                                    <div className="flex items-center justify-between group">
                                      <span className="text-gray-600 dark:text-gray-400 flex-shrink-0">Location</span>
                                      <div className="flex items-center gap-1 min-w-0">
                                        <span className="truncate font-mono text-xs max-w-56">{vuln.locations?.[0]?.path}</span>
                                        <button
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            handleCopy(vuln.locations?.[0]?.path || '', `${vulnKey}-location`);
                                          }}
                                          className="opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded flex-shrink-0"
                                        >
                                          {copiedItems.has(`${vulnKey}-location`) ? (
                                            <Check className="h-3 w-3 text-green-500" />
                                          ) : (
                                            <Copy className="h-3 w-3 text-gray-500" />
                                          )}
                                        </button>
                                      </div>
                                    </div>
                                  )}
                                </div>
                              </div>
                            </div>

                            {/* URLs and Actions */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 px-1">
                              {/* References */}
                              {vuln.urls && vuln.urls.length > 0 && (
                                <div>
                                  <h6 className="text-xs font-medium text-gray-600 dark:text-gray-400 mb-2">References</h6>
                                  <div className="space-y-1">
                                    {vuln.urls.map((url, urlIndex) => (
                                      <button
                                        key={urlIndex}
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          openExternalUrl(url);
                                        }}
                                        className="flex items-center gap-1 text-xs text-blue-600 dark:text-blue-400 hover:underline text-left"
                                      >
                                        <ArrowUpRight className="h-3 w-3" />
                                        {url}
                                      </button>
                                    ))}
                                  </div>
                                </div>
                              )}

                              {/* Data Source */}
                              {vuln.dataSource && (
                                <div className="px-1">
                                  <h6 className="text-xs font-medium text-gray-600 dark:text-gray-400 mb-2">Data Source</h6>
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      openExternalUrl(vuln.dataSource as string);
                                    }}
                                    className="flex items-center gap-1 text-xs text-blue-600 dark:text-blue-400 hover:underline text-left"
                                  >
                                    <ArrowUpRight className="h-3 w-3" />
                                    {vuln.dataSource}
                                  </button>
                                </div>
                              )}
                            </div>
                          </div>
                        </TableCell>
                      </TableRow>
                    )}
                  </React.Fragment>
                );
              })}
            </TableBody>
          </Table>
        </Card>
      )}

      {/* No Results State */}
      {!loading && !scanning && filteredVulnerabilities.length === 0 && scanResult && (
        <div className="text-center py-8">
          <Shield className="h-12 w-12 text-gray-300 dark:text-gray-600 mx-auto mb-3" />
          <p className="text-sm text-gray-500 dark:text-gray-400">No vulnerabilities found</p>
          <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">
            This image appears to be secure
          </p>
        </div>
      )}

      {/* No Scan Results State */}
      {!loading && !scanning && !scanResult && (
        <div className="text-center py-8">
          <Shield className="h-12 w-12 text-gray-300 dark:text-gray-600 mx-auto mb-3" />
          <p className="text-sm text-gray-500 dark:text-gray-400">No scan results available</p>
          <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">
            Click Re-scan to scan this image
          </p>
        </div>
      )}
    </div>
  );
};

export default ImageVulnReport;
