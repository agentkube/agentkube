name: "macOS Intel Build Automation"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version for the release (e.g., 1.0.0)'
        required: true
        type: string
      create_release:
        description: 'Create/update draft release'
        required: false
        default: true
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-macos-intel:
    name: Build macOS Intel Binaries
    runs-on: macos-13  # Use macOS 13 for Intel runners
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Setup Python for orchestrator build
      - name: Set up Python for orchestrator
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      # Setup Go for operator build
      - name: Set up Go for operator
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      # Setup Rust for Tauri
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-apple-darwin
      
      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> src-tauri/target
      
      # Setup Node.js
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
      
      - name: Install bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      # Setup Apple API Key securely
      - name: Setup Apple API Key
        run: |
          mkdir -p ~/.private_keys
          echo "${{ secrets.APPLE_API_KEY_CONTENT }}" | base64 --decode > ~/.private_keys/AuthKey_${{ secrets.APPLE_API_KEY }}.p8
          chmod 600 ~/.private_keys/AuthKey_${{ secrets.APPLE_API_KEY }}.p8
      
      # Import Apple Developer certificates
      - name: Import Apple certificates
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings build.keychain
          
          # Import Developer ID certificate
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          
          # Verify certificate is available
          security find-identity -v -p codesigning build.keychain
          
          # Clean up certificate file
          rm certificate.p12
      
      # Build orchestrator binary for Intel
      - name: Install orchestrator dependencies
        working-directory: internal/orchestrator
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build orchestrator for macOS Intel
        working-directory: internal/orchestrator
        run: |
          python build.py --platform mac
      
      # Build operator binary for Intel
      - name: Get operator build info
        id: operator_build_info
        working-directory: internal/operator
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          BUILD_TIME=$(date +%FT%T%z)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
      
      - name: Create operator dist directory
        working-directory: internal/operator
        run: mkdir -p ./dist
      
      - name: Build operator for macOS Intel
        working-directory: internal/operator
        env:
          GOOS: darwin
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          LDFLAGS="-s -w -X main.version=${{ steps.operator_build_info.outputs.version }} -X main.buildTime=${{ steps.operator_build_info.outputs.build_time }}"
          go build -trimpath -ldflags "$LDFLAGS" -o ./dist/agentkube-operator-x86_64-apple-darwin ./cmd/server/main.go
      
      - name: Make operator binary executable
        working-directory: internal/operator
        run: chmod +x ./dist/agentkube-operator-x86_64-apple-darwin
      
      # Sign individual binaries with entitlements
      - name: Sign orchestrator and operator binaries
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          # Function to sign a binary if it exists
          sign_binary() {
            local binary_path="$1"
            if [ -f "$binary_path" ]; then
              echo "Signing $binary_path..."
              # Remove any existing signature
              codesign --remove-signature "$binary_path" 2>/dev/null || true
              
              # Sign with entitlements
              codesign --timestamp --options=runtime \
                --entitlements src-tauri/deploy/mac/entitlements.mac.plist \
                --sign "$APPLE_SIGNING_IDENTITY" \
                "$binary_path"
              
              # Verify signature
              codesign --verify --deep --strict --verbose=2 "$binary_path"
              echo "✅ Successfully signed $binary_path"
            else
              echo "⚠️ Binary not found: $binary_path"
            fi
          }
          
          # Sign Intel binaries
          sign_binary "internal/orchestrator/dist/agentkube-orchestrator-x86_64-apple-darwin"
          sign_binary "internal/operator/dist/agentkube-operator-x86_64-apple-darwin"
      
      # Create directories and copy binaries to Tauri structure
      - name: Prepare Tauri binary directories
        run: |
          mkdir -p src-tauri/bin/orchestrator
          mkdir -p src-tauri/bin/operator
      
      - name: Copy built binaries to Tauri structure
        run: |
          # Copy Intel binaries
          if [ -f "internal/orchestrator/dist/agentkube-orchestrator-x86_64-apple-darwin" ]; then
            cp internal/orchestrator/dist/agentkube-orchestrator-x86_64-apple-darwin src-tauri/bin/orchestrator/
          fi
          if [ -f "internal/operator/dist/agentkube-operator-x86_64-apple-darwin" ]; then
            cp internal/operator/dist/agentkube-operator-x86_64-apple-darwin src-tauri/bin/operator/
          fi
          
          # List copied files
          find src-tauri/bin -type f -exec ls -la {} \;
      
      # Install frontend dependencies
      - name: Install frontend dependencies
        run: bun install
      
      # Build Tauri application for Intel
      - name: Build Tauri application for macOS Intel
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_API_ISSUER: ${{ secrets.APPLE_API_ISSUER }}
          APPLE_API_KEY: ${{ secrets.APPLE_API_KEY }}
          APPLE_API_KEY_PATH: ~/.private_keys/AuthKey_${{ secrets.APPLE_API_KEY }}.p8
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
        run: |
          echo "Building Tauri app for Intel (x86_64)"
          bun tauri build --target x86_64-apple-darwin
      
      # Find and list all build artifacts
      - name: List build artifacts
        run: |
          echo "Build artifacts in target directory:"
          find src-tauri/target -name "*.dmg" -o -name "*.app" -o -name "*.tar.gz" -o -name "*.zip" | while read file; do
            if [ -f "$file" ]; then
              echo "$file (Size: $(du -h "$file" | cut -f1))"
            fi
          done
      
      # Upload build artifacts
      - name: Upload macOS Intel binaries
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-binaries
          path: |
            internal/orchestrator/dist/agentkube-orchestrator-x86_64-apple-darwin
            internal/operator/dist/agentkube-operator-x86_64-apple-darwin
          retention-days: 7
      
      - name: Upload Tauri build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-tauri-build
          path: |
            src-tauri/target/x86_64-apple-darwin/release/bundle/**/*
          retention-days: 7
      
      # Cleanup keychain
      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain build.keychain 2>/dev/null || true
          rm -f ~/.private_keys/AuthKey_*.p8 2>/dev/null || true
      
      # Create or update release if requested
      - name: Create or update draft release
        if: ${{ inputs.create_release }}
        uses: actions/github-script@v7
        env:
          VERSION: ${{ inputs.version }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const version = process.env.VERSION;
            const tagName = `v${version}`;
            
            // Check if release already exists
            let release;
            try {
              const { data } = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tagName
              });
              release = data;
              console.log(`Found existing release: ${release.id}`);
            } catch (error) {
              if (error.status === 404) {
                // Create new release
                const { data } = await github.rest.repos.createRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag_name: tagName,
                  name: `Agentkube v${version}`,
                  body: `# Agentkube v${version}
            
            ## macOS Intel (x86_64) Build
            
            This release includes:
            - macOS Intel binaries (orchestrator & operator)
            - Tauri application (.dmg) for Intel Macs
            - Code signed and notarized binaries
            - Apple Developer ID signed
            
            ### Installation (Intel Macs)
            1. Download the Intel .dmg file
            2. Mount the DMG and drag Agentkube to Applications
            3. Launch Agentkube from Applications folder
            
            ### Manual Installation
            If you prefer manual installation:
            1. Download the individual Intel binaries
            2. Place them in your preferred directory (e.g., /usr/local/bin)
            3. Make them executable: \`chmod +x binary-name\`
            
            ---
            
            *This release was automatically generated using GitHub Actions*
            `,
                  draft: true,
                  prerelease: false
                });
                release = data;
                console.log(`Created new release: ${release.id}`);
              } else {
                throw error;
              }
            }
            
            console.log(`Release URL: ${release.html_url}`);
            return release.id;

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: build-macos-intel
    if: always()
    
    steps:
      - name: Build Summary
        run: |
          echo "## macOS Intel Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Architecture**: Intel (x86_64)" >> $GITHUB_STEP_SUMMARY
          echo "- **Create Release**: ${{ inputs.create_release }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build-macos-intel.result }}" == "success" ]; then
            echo "**✅ Build completed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "**❌ Build failed**" >> $GITHUB_STEP_SUMMARY
          fi