name: Build Orchestrator - All Platforms

on:
  workflow_dispatch:

jobs:
  build-all:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          # Linux builds
          - os: ubuntu-latest
            platforms: '["linux", "linux-arm"]'
            runner_name: "Linux"
          # Windows builds  
          - os: windows-latest
            platforms: '["win64", "win32", "win-arm"]'
            runner_name: "Windows"
          # macOS builds
          - os: macos-latest
            platforms: '["mac", "mac-arm"]'
            runner_name: "macOS"
    
    runs-on: ${{ matrix.os }}
    name: Build Orchestrator on ${{ matrix.runner_name }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up cross-compilation tools (Linux ARM64)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu
    
    - name: Install dependencies
      working-directory: internal/orchestrator
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build executables
      working-directory: internal/orchestrator
      run: |
        $platforms = '${{ matrix.platforms }}' | ConvertFrom-Json
        foreach ($platform in $platforms) {
          Write-Host "Building orchestrator for platform: $platform"
          python build.py --platform $platform
        }
      shell: pwsh
    
    - name: Make Linux executables executable
      if: matrix.os == 'ubuntu-latest'
      working-directory: internal/orchestrator
      run: |
        find dist/ -type f -name "agentkube-orchestrator-*-linux-gnu" -exec chmod +x {} \;
    
    - name: Remove code signature from macOS binaries
      if: matrix.os == 'macos-latest'
      working-directory: internal/orchestrator
      run: |
        echo "Removing existing signature (if any) from macOS binaries..."
        find dist/ -type f -name "agentkube-orchestrator-*-apple-darwin" -exec codesign --remove-signature {} \; || true
    
    - name: Upload all artifacts
      uses: actions/upload-artifact@v4
      with:
        name: orchestrator-${{ matrix.runner_name }}-executables
        path: internal/orchestrator/dist/
        retention-days: 4