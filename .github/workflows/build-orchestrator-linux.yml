name: Build Orchestrator - Linux Artifacts

on:
  workflow_dispatch:

jobs:
  build-linux-x86_64:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      working-directory: internal/orchestrator
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.linux.txt
        pip install pyinstaller
    
    - name: Build executable
      working-directory: internal/orchestrator
      run: |
        python build.py --platform linux
    
    - name: Make executable
      working-directory: internal/orchestrator
      run: |
        chmod +x dist/agentkube-orchestrator-x86_64-unknown-linux-gnu
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: agentkube-orchestrator-x86_64-unknown-linux-gnu
        path: internal/orchestrator/dist/agentkube-orchestrator-x86_64-unknown-linux-gnu
        retention-days: 4

  build-linux-aarch64:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build ARM64 binary in Docker
      working-directory: internal/orchestrator
      run: |
        docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}/internal/orchestrator:/workspace \
          -w /workspace \
          arm64v8/python:3.11-slim \
          bash -c "
            apt-get update && \
            apt-get install -y binutils && \
            pip install --upgrade pip && \
            pip install -r requirements.linux.txt && \
            pip install pyinstaller && \
            python build.py --platform linux-arm && \
            chmod +x dist/agentkube-orchestrator-aarch64-unknown-linux-gnu
          "
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: agentkube-orchestrator-aarch64-unknown-linux-gnu
        path: internal/orchestrator/dist/agentkube-orchestrator-aarch64-unknown-linux-gnu
        retention-days: 4